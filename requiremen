import os
import json
import logging
from telegram import Update, ReplyKeyboardMarkup, KeyboardButton
from telegram.ext import (
    Application, CommandHandler, MessageHandler,
    ContextTypes, filters, ConversationHandler
)
import requests
from bs4 import BeautifulSoup

# –í–∫–ª—é—á–∞–µ–º –ª–æ–≥–∏
logging.basicConfig(level=logging.INFO)

# –°—Ç–∞–¥–∏–∏ ConversationHandler
(
    SELECT_CITIES, SELECT_CATEGORIES, SET_PRICE_RANGE,
    SET_SEARCH_QUERY, SAVE_CONFIG, PARSE
) = range(6)

# –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –ø–∞–º—è—Ç–∏ (–≤—Ä–µ–º–µ–Ω–Ω–æ)
user_data = {}

# –ì–æ—Ä–æ–¥–∞ –ë–µ–ª–∞—Ä—É—Å–∏ (–ø—Ä–∏–º–µ—Ä)
CITIES = ["–ú–∏–Ω—Å–∫", "–ì–æ–º–µ–ª—å", "–ú–æ–≥–∏–ª—ë–≤", "–í–∏—Ç–µ–±—Å–∫", "–ì—Ä–æ–¥–Ω–æ", "–ë—Ä–µ—Å—Ç", "–ë–æ–±—Ä—É–π—Å–∫", "–ë–∞—Ä–∞–Ω–æ–≤–∏—á–∏"]
# –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ (–ø—Ä–∏–º–µ—Ä)
CATEGORIES = {
    "–ê–≤—Ç–æ": ["–õ–µ–≥–∫–æ–≤—ã–µ", "–ú–æ—Ç–æ", "–ó–∞–ø—á–∞—Å—Ç–∏"],
    "–ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å": ["–ö–≤–∞—Ä—Ç–∏—Ä—ã", "–î–æ–º–∞", "–ö–æ–º–Ω–∞—Ç—ã"],
    "–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞": ["–¢–µ–ª–µ—Ñ–æ–Ω—ã", "–ö–æ–º–ø—å—é—Ç–µ—Ä—ã"],
    "–†–∞–±–æ—Ç–∞": ["–í–∞–∫–∞–Ω—Å–∏–∏", "–†–µ–∑—é–º–µ"]
}

TOKEN = os.getenv("BOT_TOKEN")  # –±–µ—Ä—ë–º —Ç–æ–∫–µ–Ω –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    user_data[user_id] = {
        "cities": [],
        "categories": [],
        "price_min": 0,
        "price_max": 1000000,
        "search_query": "",
        "config_name": ""
    }
    kb = [["–í—ã–±—Ä–∞—Ç—å –≥–æ—Ä–æ–¥–∞", "–ú–µ–Ω—é –∫–∞—Ç–µ–≥–æ—Ä–∏–π"], ["–¶–µ–Ω–∞ –æ—Ç/–¥–æ", "–ü–æ–∏—Å–∫"],
          ["–°–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥", "–ü–∞—Ä—Å–∏–Ω–≥"]]
    reply_markup = ReplyKeyboardMarkup(kb, resize_keyboard=True)
    await update.message.reply_text("–ü—Ä–∏–≤–µ—Ç! –í—ã–±–µ—Ä–∏ –¥–µ–π—Å—Ç–≤–∏–µ:", reply_markup=reply_markup)

# ----------------- –ì–æ—Ä–æ–¥–∞ -----------------
async def ask_cities(update: Update, context: ContextTypes.DEFAULT_TYPE):
    buttons = [CITIES[i:i+3] for i in range(0, len(CITIES), 3)]
    buttons.append(["‚úÖ –ì–æ—Ç–æ–≤–æ"])
    reply_markup = ReplyKeyboardMarkup(buttons, resize_keyboard=True)
    await update.message.reply_text("–í—ã–±–µ—Ä–∏ –¥–æ 3 –≥–æ—Ä–æ–¥–æ–≤ (–Ω–∞–∂–∏–º–∞–π –Ω–∞ –Ω–∞–∑–≤–∞–Ω–∏—è):", reply_markup=reply_markup)
    return SELECT_CITIES

async def select_cities(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    city = update.message.text
    if city == "‚úÖ –ì–æ—Ç–æ–≤–æ":
        await start(update, context)
        return ConversationHandler.END
    if city in CITIES:
        if len(user_data[user_id]["cities"]) < 3:
            if city not in user_data[user_id]["cities"]:
                user_data[user_id]["cities"].append(city)
        await update.message.reply_text(f"–í—ã–±—Ä–∞–Ω–æ: {', '.join(user_data[user_id]['cities'])}")
    return SELECT_CITIES

# ----------------- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ -----------------
async def ask_categories(update: Update, context: ContextTypes.DEFAULT_TYPE):
    kb = [[cat] for cat in CATEGORIES.keys()]
    kb.append(["‚úÖ –ù–∞–∑–∞–¥"])
    reply_markup = ReplyKeyboardMarkup(kb, resize_keyboard=True)
    await update.message.reply_text("–í—ã–±–µ—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é:", reply_markup=reply_markup)
    return SELECT_CATEGORIES

async def select_categories(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    cat = update.message.text
    if cat == "‚úÖ –ù–∞–∑–∞–¥":
        await start(update, context)
        return ConversationHandler.END
    if cat in CATEGORIES:
        subcats = CATEGORIES[cat]
        kb = [[sc] for sc in subcats] + [["‚úÖ –ù–∞–∑–∞–¥ –∫ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º"]]
        reply_markup = ReplyKeyboardMarkup(kb, resize_keyboard=True)
        await update.message.reply_text(f"–í—ã–±–µ—Ä–∏ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—é –≤ '{cat}':", reply_markup=reply_markup)
        context.user_data["current_category"] = cat
        return SELECT_CATEGORIES
    # –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–∞ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è
    for main_cat, subs in CATEGORIES.items():
        if cat in subs:
            full_cat = f"{main_cat} / {cat}"
            if full_cat not in user_data[user_id]["categories"]:
                user_data[user_id]["categories"].append(full_cat)
            await update.message.reply_text(f"–î–æ–±–∞–≤–ª–µ–Ω–æ: {full_cat}")
            return SELECT_CATEGORIES
    await update.message.reply_text("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ–ø—Ü–∏—è.")
    return SELECT_CATEGORIES

# ----------------- –¶–µ–Ω–∞ -----------------
async def ask_price(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("–í–≤–µ–¥–∏ –¥–∏–∞–ø–∞–∑–æ–Ω —Ü–µ–Ω—ã —á–µ—Ä–µ–∑ –ø—Ä–æ–±–µ–ª: –Ω–∞–ø—Ä–∏–º–µ—Ä ‚Üí `100 50000`")
    return SET_PRICE_RANGE

async def set_price(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    try:
        pmin, pmax = map(int, update.message.text.split())
        if pmin < 0 or pmax < pmin:
            raise ValueError
        user_data[user_id]["price_min"] = pmin
        user_data[user_id]["price_max"] = pmax
        await update.message.reply_text(f"–¶–µ–Ω–∞: –æ—Ç {pmin} –¥–æ {pmax}")
    except:
        await update.message.reply_text("–û—à–∏–±–∫–∞! –í–≤–µ–¥–∏—Ç–µ –¥–≤–∞ —á–∏—Å–ª–∞: –º–∏–Ω –∏ –º–∞–∫—Å.")
        return SET_PRICE_RANGE
    await start(update, context)
    return ConversationHandler.END

# ----------------- –ü–æ–∏—Å–∫ -----------------
async def ask_search(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("–í–≤–µ–¥–∏—Ç–µ –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å (–∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞):")
    return SET_SEARCH_QUERY

async def set_search(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    user_data[user_id]["search_query"] = update.message.text
    await update.message.reply_text(f"–ü–æ–∏—Å–∫: '{update.message.text}'")
    await start(update, context)
    return ConversationHandler.END

# ----------------- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥–∞ -----------------
async def ask_save_config(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (–ª–∞—Ç–∏–Ω–∏—Ü–µ–π, –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤):")
    return SAVE_CONFIG

async def save_config(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    name = update.message.text.strip()
    if not name.isalnum():
        await update.message.reply_text("–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã –∏ —Ü–∏—Ñ—Ä—ã!")
        return SAVE_CONFIG
    config = user_data[user_id].copy()
    config.pop("config_name", None)
    os.makedirs("configs", exist_ok=True)
    with open(f"configs/{user_id}_{name}.json", "w", encoding="utf-8") as f:
        json.dump(config, f, ensure_ascii=False, indent=2)
    await update.message.reply_text(f"‚úÖ –ö–æ–Ω—Ñ–∏–≥ '{name}' —Å–æ—Ö—Ä–∞–Ω—ë–Ω!")
    await start(update, context)
    return ConversationHandler.END

# ----------------- –ü–∞—Ä—Å–∏–Ω–≥ -----------------
def scrape_kufar(cities, categories, price_min, price_max, query):
    # –£–ø—Ä–æ—â—ë–Ω–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ —á–µ—Ä–µ–∑ Kufar API –∏–ª–∏ HTML
    # –í —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π API, –Ω–æ –µ–≥–æ –Ω–µ—Ç ‚Üí –ø–∞—Ä—Å–∏–º HTML
    results = []

    # –ü—Ä–∏–º–µ—Ä: –ø–∞—Ä—Å–∏–º –ú–∏–Ω—Å–∫, –∫–∞—Ç–µ–≥–æ—Ä–∏—è "–ê–≤—Ç–æ / –õ–µ–≥–∫–æ–≤—ã–µ"
    for city in cities[:1]:  # –û–≥—Ä–∞–Ω–∏—á–∏–º 1 –≥–æ—Ä–æ–¥–æ–º –¥–ª—è –¥–µ–º–æ
        for cat in categories[:1]:  # –∏ 1 –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π
            city_code = city.lower().replace("—ë", "–µ")
            cat_url_part = cat.replace(" ", "-").replace("/", "").lower()

            url = f"https://auto.kufar.by/listings?ot=1&query={query}&rgn={city_code}"
            try:
                res = requests.get(url, timeout=10)
                soup = BeautifulSoup(res.text, 'lxml')
                listings = soup.select('a[href^="https://auto.kufar.by/"]')[:3]  # –ø–µ—Ä–≤—ã–µ 3
                for item in listings:
                    title = item.get_text(strip=True)
                    link = item['href']
                    if title and len(title) > 10:
                        results.append(f"{title}\n{link}")
            except Exception as e:
                results.append(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ: {str(e)}")
            break
        break
    return results or ["–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ üòï"]

async def parse(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    data = user_data[user_id]
    msg = await update.message.reply_text("üîç –ò—â—É –æ–±—ä—è–≤–ª–µ–Ω–∏—è...")
    results = scrape_kufar(
        data["cities"],
        data["categories"],
        data["price_min"],
        data["price_max"],
        data["search_query"]
    )
    await msg.edit_text("\n\n".join(results[:5]))  # –ø—Ä–∏—Å—ã–ª–∞–µ–º –ø–µ—Ä–≤—ã–µ 5

# ----------------- –û—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ø—É—Å–∫ -----------------
def main():
    app = Application.builder().token(TOKEN).build()

    conv_handler = ConversationHandler(
        entry_points=[
            MessageHandler(filters.Regex("–í—ã–±—Ä–∞—Ç—å –≥–æ—Ä–æ–¥–∞"), ask_cities),
            MessageHandler(filters.Regex("–ú–µ–Ω—é –∫–∞—Ç–µ–≥–æ—Ä–∏–π"), ask_categories),
            MessageHandler(filters.Regex("–¶–µ–Ω–∞ –æ—Ç/–¥–æ"), ask_price),
            MessageHandler(filters.Regex("–ü–æ–∏—Å–∫"), ask_search),
            MessageHandler(filters.Regex("–°–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥"), ask_save_config),
            MessageHandler(filters.Regex("–ü–∞—Ä—Å–∏–Ω–≥"), parse),
        ],
        states={
            SELECT_CITIES: [MessageHandler(filters.TEXT & ~filters.COMMAND, select_cities)],
            SELECT_CATEGORIES: [MessageHandler(filters.TEXT & ~filters.COMMAND, select_categories)],
            SET_PRICE_RANGE: [MessageHandler(filters.TEXT & ~filters.COMMAND, set_price)],
            SET_SEARCH_QUERY: [MessageHandler(filters.TEXT & ~filters.COMMAND, set_search)],
            SAVE_CONFIG: [MessageHandler(filters.TEXT & ~filters.COMMAND, save_config)],
        },
        fallbacks=[CommandHandler("start", start)],
    )

    app.add_handler(CommandHandler("start", start))
    app.add_handler(conv_handler)

    app.run_polling()

if __name__ == "__main__":
    main()
